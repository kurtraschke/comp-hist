#!/usr/bin/perl -w

#Tovcg, freedom from Graphviz

$minyear = 3000;
$maxyear = 0;
$linkcnt = 0;
$height = $maxyear - $minyear + 2;
$width = $nodecnt / 2;

while(<>){
       if(/.*\#/){ next; }
       if(/(\S+)/){ $node = $1; next; }
       if(/.*Name: (.*)/){$name{$node} = $1; $nodecnt{$node}++; next;}

       if(/.*Successor to (.*)/){
            $from{$linkcnt} = $1; $to{$linkcnt} = $node; $weight{$linkcnt} = "10";
	    $linkcnt++;
	}

       if(/.*Code taken from (.*)/){
            $from{$linkcnt} = $1; $to{$linkcnt} = $node; $weight{$linkcnt} = "7";
            $linkcnt++;
        }

       if(/.*Influenced by (.*)/){
            $from{$linkcnt} = $1; $to{$linkcnt} = $node; $weight{$linkcnt} = "4";
            $linkcnt++;
        }

	if(/.*Type: hardware/){ $color{$node} = "yellow"; }
	if(/.*Type: [OS|os]/){ $color{$node} = "blue"; }
	if(/.*Type: standard/){ $color{$node} = "red"; }
	if(/.*Type: language/){ $color{$node} = "green"; }

        if (/.*Date:.*(\d\d\d\d)-(\d\d)-(\d\d)/) {
                               # Convert to year-mon
            $yr=$1; $mon=$2; goto dodate;
	}
        if (/.*Date:.*(\d\d\d\d)-(\d\d)/) {
            $yr=$1; $mon=$2; goto dodate;
        }
        if (/.*Date:.*(\d\d\d\d)/) {
            $yr=$1; $mon="00";

dodate:
	$date{$node} = $yr.$mon;
        if ($yr > $maxyear) { $maxyear=$yr; }
        if ($yr < $minyear) { $minyear=$yr; }
        next;
	}
   }

print("graph: { title = comp-hist\n\n");
print("smanhatten_edges: yes\nlayoutalgorithm: tree\n");
print("scaling: 0.34\n");
print("x: 120 y: 20\nxmax: 1152\nymax: 900\n");
print("width: $width \n");
print("height: $height \n\n");
print("color: white\n");
print("edge.color: black\n");
print("node.textcolor: black\n\n");

#draw the visible years
$i = $minyear;       
while ($i < $maxyear) {
    print("node: { width: 138 height: 74 bordercolor: black borderwidth: 7 title: $i label: $i color: $color{$node} } \n");
}

$i = $minyear;
while($i < $maxyear){
     print("edge: { sourcename: $i ");
     $i++;
     print("targetname: $i \n }");
}
print("\n");

foreach $node (%name) {
    print("node: { width: 138 height: 74 bordercolor: black borderwidth: 7 title: $node label: $name{$node} color: $color{$node} } \n") ;
    print("node: { width: 0 height: 0 borderwidth: 0 title: $date{$node}.$nodecnt{$node} }\n");
    print("nearedge: { sourcename: $node targetname: $date{$node}.$nodecnt{$node} }\n\n");
}

$h = 0
while($h < $linkcnt){
     print("edge: { sourcename: $from{$i} targetname: $to{$i} thickness: $weight{$i} arrowsize: 20 } \n");
 }

print("\n}\n");
